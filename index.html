<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Assistant | Chimeric AI | NotHans</title>

    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png" />
    <link rel="mask-icon" href="images/safari-pinned-tab.svg" color="#5bbad5" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
        integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous" />
    <link href="styles/prism.css?v0.1.1" rel="stylesheet" />
    <link href="styles/prism-custom.css?v0.1.1" rel="stylesheet" />
    <link href="styles/styles.css?v0.1.1" rel="stylesheet" />
    <link href="styles/thinking.css?v0.1.1" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.3/full/pyodide.js"></script>
</head>

<body class="d-flex flex-column min-vh-100">
    <header class="bg-primary py-2">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="text-white mb-0">
                    <i class="bi bi-terminal"></i> <span id="app_name">AI</span>
                    <span class="d-none d-sm-inline">Assistant</span>
                </h1>
                <div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <span class="d-none d-sm-inline"><i class="bi bi-gear-fill"></i></span>
                            <span class="current-mode">Default</span>
                        </button>
                        <ul class="dropdown-menu" id="app_modes">
                            <li>
                                <a class="dropdown-item" href="#" data-mode="Default">Default</a>
                            </li>                         
                            <li>
                                <a class="dropdown-item" href="#" data-mode="Math">Math</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" data-mode="Flashcard">Flashcard</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" data-mode="Custom">Custom</a>
                            </li>
                        </ul>
                    </div>
                    <button type="button" class="btn btn-light btn-sm me-2 d-none" id="custom_button"
                        data-bs-toggle="modal" data-bs-target="#customPromptModal">
                        <i class="bi bi-pencil-square"></i>
                        <span class="d-none d-sm-inline">Custom</span>
                    </button>
                    <button class="btn btn-light btn-sm me-2" onclick="download_running_session()">
                        <i class="bi bi-download"></i>
                        <span class="d-none d-sm-inline">Download</span>
                    </button>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="bi bi-gear"></i>
                        <span class="d-none d-sm-inline">Settings</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="scrollable-area" id="scrollableArea">
        <div class="container">
            <div class="row" id="responseArea"></div>
            <div class="is-thinking mx-auto my-2 d-none" id="renderingArea">
                <div class="thinking-dot-1"></div>
                <div class="thinking-dot-2"></div>
                <div class="thinking-dot-3"></div>
                <div class="thinking-dot-4"></div>
                <div class="thinking-dot-5"></div>
            </div>
        </div>
    </main>

    <footer class="footer bg-secondary mt-auto py-3">
        <div class="container">
            <div class="row">
                <div class="col-12 d-flex">
                    <button class="btn btn-primary" id="random_prompt_button" type="button"
                        onclick="openai_completions(random_user_prompt())">
                        <i class="bi bi-shuffle"></i>
                    </button>
                    <input type="text" class="form-control mx-2" id="user_prompt_field" value="" />
                    <button class="btn btn-primary" type="button" id="user_prompt_button"
                        onclick="openai_completions()">
                        <i class="bi bi-chat-square-fill"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12 text-center">
                    <p class="small">
                        <i class="bi bi-stars"></i> Surprises are possible.
                        <i class="bi bi-github"></i> <a href="https://nothans.com/ai" target="_blank"
                            class="text-muted">NotHans</a>
                        <i class="bi bi-tag-fill" aria-hidden="true"></i> <a href="https://github.com/nothans/code-assistant" target="_blank"
                        class="text-muted">v1.0.0</a>
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="customPromptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Custom Prompt Settings <button type="button"
                            class="btn btn-success ms-auto" id="save_changes">
                            <i class="bi bi-save"></i> Save
                        </button></h5>
                    <button type="button" class="btn btn-close" data-bs-dismiss="modal"></button>

                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="mb-3">
                            <label for="system_prompt" class="form-label">
                                <h6>System Prompt</h6>
                            </label>
                            <textarea class="form-control" id="system_prompt" name="system_prompt" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="default_assistant_message" class="form-label">
                                        <h6>Default Assistant Message</h6>
                                    </label>
                                    <input type="text" class="form-control" id="default_assistant_message"
                                        name="default_assistant_message" />
                                </div>
                                <div class="mb-3">
                                    <label for="default_prompt" class="form-label">
                                        <h6>Default User Prompt</h6>
                                    </label>
                                    <input type="text" class="form-control" id="default_prompt" name="default_prompt" />
                                </div>
                                <div class="mb-3">
                                    <label for="user_prompt_format" class="form-label">
                                        <h6>User Prompt Format</h6>
                                    </label>
                                    <input type="text" class="form-control" id="user_prompt_format"
                                        name="user_prompt_format" />
                                </div>
                                <div class="mb-3">
                                    <label for="temperature" class="form-label">
                                        <h6>Temperature</h6>
                                    </label>
                                    <input type="number" step="0.1" class="form-control" id="temperature"
                                        name="temperature" min="0" max="1" />
                                </div>
                                <div class="mb-3">
                                    <label for="model" class="form-label">
                                        <h6>Model</h6>
                                    </label>
                                    <select class="form-select" id="model" name="model">
                                        <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                                        <option value="gpt-4o">gpt-4o</option>
                                        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <h6>User Prompts</h6>
                                    </label>
                                    <div id="user_prompts_container"></div>
                                    <button type="button" class="btn btn-primary btn-sm mt-2" id="add_prompt">
                                        Add User Prompt
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="api_key_input" class="form-label">
                            <h6>OpenAI API Key</h6>
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="api_key_input" placeholder="Enter your OpenAI API key">
                            <button class="btn btn-primary" type="button" onclick="update_api_key()">Save Key</button>
                        </div>
                        <small class="form-text text-muted">Your API key is stored locally in your browser.</small>
                    </div>
                    <hr>
                    <div class="list-group">
                        <button type="button" class="list-group-item list-group-item-action" onclick="clear_cache_from_modal()">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Clear App Cache</h5>
                            </div>
                            <p class="mb-1">Clear all stored app data and reload the application.</p>
                        </button>
                        <button type="button" class="list-group-item list-group-item-action" onclick="reset_api_key()">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Reset API Key</h5>
                            </div>
                            <p class="mb-1">Clear the stored OpenAI API key and prompt for a new one.</p>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Run Code Modal -->
    <div class="modal fade" id="runCodeModal" tabindex="-1">
        <div class="modal-dialog modal-xl" style="max-width: 95vw; width: 95vw;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-play-fill"></i> Run Python Code
                    </h5>
                    <button type="button" class="btn btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Hidden storage for code (used by Run Again functionality) -->
                    <input type="hidden" id="currentCode" value="" />

                    <div class="mb-3" id="pyodideLoading" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>
                                Initializing Python runtime (this may take a moment on first use)...
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="executionLoading" style="display: none;">
                        <div class="alert alert-primary d-flex align-items-center" role="alert">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Executing...</span>
                            </div>
                            <div>
                                Executing code...
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="outputSection" style="display: none;">
                        <div class="bg-success bg-opacity-10 p-3 rounded border border-success" id="codeOutput" style="white-space: pre-wrap; max-height: 70vh; overflow-y: auto; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9em; line-height: 1.4;"></div>
                    </div>

                    <div class="mb-3" id="errorSection" style="display: none;">
                        <label for="codeError" class="form-label">
                            <h6>Error</h6>
                        </label>
                        <pre class="bg-danger bg-opacity-10 p-3 rounded border border-danger" id="codeError" style="white-space: pre-wrap; max-height: 50vh; overflow-y: auto;"></pre>
                    </div>

                    <div class="mb-3" id="executionTime" style="display: none;">
                        <small class="text-muted">
                            <i class="bi bi-stopwatch"></i> Execution time: <span id="executionTimeValue">0</span>ms
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" id="runCodeAgain">
                        <i class="bi bi-arrow-clockwise"></i> Run Again
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
        integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <script src="scripts/prism.js?v0.1.5"></script>
    <script src="scripts/prism-buttons.js?v0.1.5"></script>
    <script src="scripts/app.js?v0.1.5"></script>
    <script src="scripts/prompt-settings.js?v0.1.5"></script>
</body>

</html>
